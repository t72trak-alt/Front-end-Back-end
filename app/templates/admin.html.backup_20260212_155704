<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель администратора - AI Developer Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- ДОБАВЛЕНО: Исправление чата -->
    <link rel="stylesheet" href="/static/css/chat-fix.css">
    <style>
        .sidebar { transition: all 0.3s; }
        .chat-panel { transition: all 0.3s; }
        .active-tab { background-color: #3b82f6; color: white; }
        .message-admin { background-color: #3b82f6; color: white; margin-left: auto; }
        .message-user { background-color: #e5e7eb; color: #1f2937; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
        
        /* ДОПОЛНИТЕЛЬНЫЕ ИСПРАВЛЕНИЯ ДЛЯ ЧАТА */
        #chat-input, #message-input {
            color: #000000 !important;
            -webkit-text-fill-color: #000000 !important;
            opacity: 1 !important;
            font-weight: 400 !important;
        }
        
        #chat-input::placeholder, #message-input::placeholder {
            color: #666666 !important;
            opacity: 1 !important;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Верхняя панель -->
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold">AI Developer Portal - Админ-панель</h1>
                <span class="bg-blue-800 px-3 py-1 rounded-full text-sm">Администратор</span>
            </div>
            <div class="flex items-center space-x-4">
                <span id="admin-email">t72trak@gmail.com</span>
                <a href="/dashboard" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded transition">В личный кабинет</a>
                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded transition">Выход</button>
            </div>
        </div>
    </nav>
    <!-- Основной контейнер с тремя колонками -->
    <div class="container mx-auto flex mt-4 gap-4" style="min-height: calc(100vh - 140px);">
        <!-- ЛЕВАЯ КОЛОНКА: Навигация -->
        <div class="sidebar w-64 bg-white rounded-lg shadow-lg p-4 overflow-y-auto">
            <h2 class="text-lg font-bold mb-4 text-gray-700 border-b pb-2">📊 Навигация</h2>
            <div class="space-y-1">
                <button onclick="loadTab('users')" class="tab-btn w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center" id="tab-users">
                    <span class="mr-2">👤</span> Пользователи
                </button>
                <button onclick="loadTab('projects')" class="tab-btn w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center" id="tab-projects">
                    <span class="mr-2">📁</span> Проекты
                </button>
                <button onclick="loadTab('services')" class="tab-btn w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center" id="tab-services">
                    <span class="mr-2">🔧</span> Услуги
                </button>
                <button onclick="loadTab('transactions')" class="tab-btn w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center" id="tab-transactions">
                    <span class="mr-2">💰</span> Платежи
                </button>
                <button onclick="loadTab('statistics')" class="tab-btn w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center" id="tab-statistics">
                    <span class="mr-2">📈</span> Статистика
                </button>
                <button onclick="loadTab('settings')" class="tab-btn w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center" id="tab-settings">
                    <span class="mr-2">⚙️</span> Настройки
                </button>
            </div>
            <!-- Быстрая статистика -->
            <div class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-100">
                <h3 class="font-bold mb-3 text-gray-700 flex items-center">
                    <span class="mr-2">🚀</span> Быстрая статистика
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">👤 Пользователи:</span>
                        <span id="stats-users" class="font-bold text-blue-600 text-lg">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">📁 Проекты:</span>
                        <span id="stats-projects" class="font-bold text-green-600 text-lg">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">🛠️ Услуги:</span>
                        <span id="stats-services" class="font-bold text-yellow-600 text-lg">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">💬 Сообщения:</span>
                        <span id="stats-messages" class="font-bold text-purple-600 text-lg">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">💰 Транзакции:</span>
                        <span id="stats-transactions" class="font-bold text-red-600 text-lg">0</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- ЦЕНТРАЛЬНАЯ КОЛОНКА: Контент -->
        <div class="flex-1 bg-white rounded-lg shadow-lg p-6 overflow-y-auto">
            <!-- Панель разработчика -->
            <div class="p-5 bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl border border-blue-200 shadow-sm mb-6">
                <h3 class="text-lg font-bold text-blue-800 mb-3 flex items-center">
                    <span class="mr-2">👨‍💻</span> Панель разработчика
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
                    <button onclick="testWebSocket()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center">
                        <span class="mr-2">🔌</span> Тест WebSocket
                    </button>
                    <button onclick="clearCache()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center">
                        <span class="mr-2">🧹</span> Очистить кэш
                    </button>
                    <button onclick="reloadData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center">
                        <span class="mr-2">🔄</span> Обновить данные
                    </button>
                </div>
                <div class="bg-gray-900 text-green-400 rounded-lg p-3 font-mono text-sm h-40 overflow-y-auto mb-6" id="dev-console">
                    <div class="text-gray-400">// Консоль разработчика</div>
                    <div>> Система инициализирована</div>
                    <div>> Ожидание команд...</div>
                </div>
                <div class="text-center">
                    <p class="text-gray-600 text-lg">Выберите раздел в левом меню для управления системой.</p>
                </div>
            </div>
            <!-- Быстрый доступ -->
            <div>
                <h3 class="text-lg font-bold text-gray-700 mb-3">⚡ Быстрый доступ</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div onclick="loadTab('users')" class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition cursor-pointer">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                                <span class="text-blue-600 text-xl">👤</span>
                            </div>
                            <div>
                                <h4 class="font-bold">Добавить пользователя</h4>
                                <p class="text-sm text-gray-500">Создать нового пользователя системы</p>
                            </div>
                        </div>
                    </div>
                    <div onclick="loadTab('projects')" class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition cursor-pointer">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                                <span class="text-green-600 text-xl">📁</span>
                            </div>
                            <div>
                                <h4 class="font-bold">Просмотр проектов</h4>
                                <p class="text-sm text-gray-500">Управление текущими проектами</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Контейнер для контента вкладок -->
            <div id="content-area" class="mt-6">
                <div class="text-center py-10 text-gray-500">
                    <div class="text-4xl mb-4">👈</div>
                    <p class="text-xl">Выберите раздел в левом меню</p>
                    <p class="text-sm mt-2">Здесь будет отображаться содержимое выбранной вкладки</p>
                </div>
            </div>
        </div>
        <!-- ПРАВАЯ КОЛОНКА: Чат -->
        <div class="chat-panel w-80 bg-white rounded-lg shadow-lg flex flex-col">
            <!-- Заголовок чата -->
            <div class="p-4 border-b bg-gradient-to-r from-blue-50 to-indigo-50">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-lg font-bold text-gray-700 flex items-center">
                        <span class="mr-2">💬</span> Чат поддержки
                    </h2>
                    <span id="chat-status" class="px-3 py-1 bg-green-100 text-green-800 text-sm rounded-full flex items-center">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                        Онлайн
                    </span>
                </div>
                <div class="flex space-x-2 mb-3">
                    <div class="relative flex-1">
                        <input type="text" id="chat-search" placeholder="Поиск пользователя..."
                               class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                               onfocus="loadUserDropdown()" oninput="filterUsers()">
                        <div id="user-dropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden">
                            <div class="p-2 text-gray-500 text-center">Загрузка пользователей...</div>
                        </div>
                    </div>
                    <button onclick="refreshChatList()" class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition">
                        🔄
                    </button>
                </div>
            </div>
            <!-- Окно чата -->
            <div class="flex-1 flex flex-col p-3" id="chat-window">
                <div class="flex-1 overflow-y-auto mb-3 p-3 bg-gray-50 rounded-lg" id="chat-messages-container">
                    <div class="text-center py-8 text-gray-400">
                        <div class="text-3xl mb-2">💬</div>
                        <p>Выберите пользователя для начала общения</p>
                    </div>
                </div>
                <div class="border-t pt-3">
                    <div class="flex space-x-2 mb-2 items-stretch">
                        <!-- ИЗМЕНЕНО: добавлен id и исправлены стили -->
                        <textarea id="chat-input" placeholder="Введите сообщение..." 
                                  class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 resize-none text-black opacity-100" 
                                  rows="2" onkeydown="handleChatKeydown(event)"
                                  style="color: #000000 !important; background-color: #ffffff !important; opacity: 1 !important;"></textarea>
                        <!-- ИЗМЕНЕНО: кнопка стала зеленой, с текстом "Отправить" и выровнена по высоте -->
                        <button onclick="sendAdminMessage()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center whitespace-nowrap font-medium h-auto">
                            Отправить
                        </button>
                    </div>
                    <div class="flex justify-between items-center">
                        <button onclick="editLastMessage()" class="text-sm text-gray-500 hover:text-gray-700">
                            ✏️ Исправить последнее
                        </button>
                        <div class="text-xs text-gray-400">
                            Enter - отправить, Shift+Enter - новая строка
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Подвал -->
    <footer class="bg-gray-800 text-white p-4 mt-4">
        <div class="container mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <p>© 2024 Front end & Back end. Все права защищены.</p>
                <div class="mt-2 md:mt-0 text-sm text-gray-400">
                    <span>Версия: 2.0.0 | </span>
                    <span>Сервер: <span id="server-status" class="text-green-400">🟢 Работает</span> | </span>
                    <span>WebSocket: <span id="ws-status" class="text-green-400">🟢 Подключен</span></span>
                </div>
            </div>
        </div>
    </footer>
    <script src="/static/js/admin.js"></script>
    <script>
        // Базовая инициализация
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Админ-панель инициализируется...');
            // Устанавливаем активную вкладку
            document.getElementById('tab-users').classList.add('active-tab');
            // Загружаем статистику
            loadQuickStats();
            // Подключаемся к WebSocket как админ
            setTimeout(connectAdminWebSocket, 1000);
            // Обновляем email админа
            updateAdminEmail();
            
            // ИСПРАВЛЕНИЕ: Принудительно применяем стили для поля ввода чата
            setTimeout(function() {
                const chatInput = document.getElementById('chat-input');
                if (chatInput) {
                    chatInput.style.color = '#000000';
                    chatInput.style.backgroundColor = '#ffffff';
                    chatInput.style.opacity = '1';
                    chatInput.classList.add('text-black', 'opacity-100');
                    console.log('Стили чата применены принудительно');
                }
            }, 500);
        });
        
        function updateAdminEmail() {
            const adminEmail = localStorage.getItem('admin_email') || 't72trak@gmail.com';
            document.getElementById('admin-email').textContent = adminEmail;
        }
        
        function logout() {
            fetch('/api/auth/logout', { method: 'POST' })
                .then(() => {
                    window.location.href = '/login';
                })
                .catch(error => {
                    console.error('Ошибка выхода:', error);
                    window.location.href = '/login';
                });
        }
        
        function loadTab(tabName) {
            console.log('Загрузка вкладки:', tabName);
            // Удаляем активный класс у всех кнопок
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active-tab');
            });
            // Добавляем активный класс текущей кнопке
            const currentTab = document.getElementById('tab-' + tabName);
            if (currentTab) {
                currentTab.classList.add('active-tab');
            }
            // Показываем загрузку
            document.getElementById('content-area').innerHTML = 
                '<div class="flex flex-col items-center justify-center py-20">' +
                '    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>' +
                '    <p class="text-gray-600">Загрузка раздела "' + tabName + '"...</p>' +
                '</div>';
            // Загружаем контент для вкладки
            fetch('/api/admin/' + tabName)
                .then(response => {
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    return response.text();
                })
                .then(html => {
                    document.getElementById('content-area').innerHTML = html;
                    console.log('Вкладка "' + tabName + '" загружена');
                })
                .catch(error => {
                    console.error('Ошибка загрузки вкладки:', error);
                    document.getElementById('content-area').innerHTML = 
                        '<div class="bg-red-50 border border-red-200 rounded-lg p-6">' +
                        '    <h3 class="text-red-800 font-bold text-lg mb-2">⚠️ Ошибка загрузки</h3>' +
                        '    <p class="text-red-600">Не удалось загрузить раздел "' + tabName + '"</p>' +
                        '    <p class="text-red-500 text-sm mt-2">' + error.message + '</p>' +
                        '    <button onclick="loadTab(\'' + tabName + '\')" class="mt-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition">' +
                        '        Попробовать снова' +
                        '    </button>' +
                        '</div>';
                });
        }
        
        function logToConsole(message) {
            const consoleEl = document.getElementById('dev-console');
            const timestamp = new Date().toLocaleTimeString();
            consoleEl.innerHTML += '<div>> [' + timestamp + '] ' + message + '</div>';
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }
        
        // Функции для окна разработчика
        function testWebSocket() {
            logToConsole('Тестирование WebSocket...');
            if (window.adminWebSocket && window.adminWebSocket.readyState === WebSocket.OPEN) {
                window.adminWebSocket.send(JSON.stringify({ 
                    type: 'test', 
                    message: 'Тест от админа',
                    timestamp: new Date().toISOString()
                }));
                logToConsole('Тестовое сообщение отправлено');
            } else {
                logToConsole('WebSocket не подключен');
            }
        }
        
        function clearCache() {
            localStorage.clear();
            sessionStorage.clear();
            logToConsole('Локальное хранилище очищено');
            showNotification('Кэш очищен', 'success');
        }
        
        function reloadData() {
            loadQuickStats();
            logToConsole('Данные обновлены');
            showNotification('Данные обновлены', 'success');
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = {
                'success': 'bg-green-100 border-green-400 text-green-700',
                'error': 'bg-red-100 border-red-400 text-red-700',
                'warning': 'bg-yellow-100 border-yellow-400 text-yellow-700',
                'info': 'bg-blue-100 border-blue-400 text-blue-700'
            };
            notification.className = 'fixed top-4 right-4 p-4 rounded-lg border-l-4 ' + colors[type] + ' shadow-lg z-50 max-w-sm';
            notification.innerHTML = 
                '<div class="flex">' +
                '    <div class="flex-shrink-0">' +
                '        ' + (type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️') +
                '    </div>' +
                '    <div class="ml-3">' +
                '        <p class="font-medium">' + message + '</p>' +
                '    </div>' +
                '    <button onclick="this.parentElement.parentElement.remove()" class="ml-auto pl-3">×</button>' +
                '</div>';
            document.body.appendChild(notification);
            // Автоматическое удаление через 5 секунд
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // ========== ФУНКЦИИ ЧАТА ==========
        function loadUserDropdown() {
            const dropdown = document.getElementById('user-dropdown');
            if (!dropdown) return;
            dropdown.classList.remove('hidden');
            fetch('/api/admin/chat/users')
                .then(response => response.json())
                .then(users => {
                    if (users.length === 0) {
                        dropdown.innerHTML = '<div class="p-2 text-gray-500 text-center">Нет пользователей</div>';
                        return;
                    }
                    let html = '';
                    users.forEach(user => {
                        const userName = user.name || 'Пользователь';
                        const safeName = userName.replace(/'/g, "\\'");
                        const safeEmail = user.email.replace(/'/g, "\\'");
                        html += 
                            '<div class="p-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 user-item"' +
                            '     data-user-id="' + user.id + '"' +
                            '     data-user-name="' + userName + '"' +
                            '     data-user-email="' + user.email + '"' +
                            '     onclick="selectUserForChat(' + user.id + ', \'' + safeName + '\', \'' + safeEmail + '\')">' +
                            '    <div class="font-medium">' + userName + '</div>' +
                            '    <div class="text-xs text-gray-500">' + user.email + '</div>' +
                            '</div>';
                    });
                    dropdown.innerHTML = html;
                })
                .catch(error => {
                    console.error('Ошибка загрузки пользователей:', error);
                    dropdown.innerHTML = '<div class="p-2 text-red-500 text-center">Ошибка загрузки</div>';
                });
        }
        
        function filterUsers() {
            const searchInput = document.getElementById('chat-search').value.toLowerCase();
            const userItems = document.querySelectorAll('.user-item');
            userItems.forEach(item => {
                const name = item.getAttribute('data-user-name').toLowerCase();
                const email = item.getAttribute('data-user-email').toLowerCase();
                if (name.includes(searchInput) || email.includes(searchInput)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function selectUserForChat(userId, userName, userEmail) {
            document.getElementById('chat-search').value = userName;
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown) dropdown.classList.add('hidden');
            // Устанавливаем активного пользователя
            window.activeChatUser = {
                id: userId,
                name: userName,
                email: userEmail
            };
            // Загружаем историю чата
            loadChatHistory(userId);
            logToConsole('Выбран пользователь: ' + userName + ' (' + userEmail + ')');
        }
        
        function loadChatHistory(userId) {
            const messagesContainer = document.getElementById('chat-messages-container');
            if (!messagesContainer) return;
            messagesContainer.innerHTML = 
                '<div class="flex flex-col items-center justify-center py-10">' +
                '    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-4"></div>' +
                '    <p class="text-gray-600">Загрузка истории сообщений...</p>' +
                '</div>';
            fetch('/api/chat/history/' + userId)
                .then(response => response.json())
                .then(messages => {
                    let html = '';
                    if (messages.length === 0) {
                        html = 
                            '<div class="text-center py-8 text-gray-400">' +
                            '    <div class="text-3xl mb-2">💬</div>' +
                            '    <p>История сообщений пуста</p>' +
                            '    <p class="text-sm mt-2">Начните диалог первым сообщением</p>' +
                            '</div>';
                    } else {
                        messages.forEach(msg => {
                            const isAdmin = msg.is_owner || msg.sender_id === 0;
                            const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            const messageClass = isAdmin ? 'justify-end' : 'justify-start';
                            const bubbleClass = isAdmin ? 'bg-blue-100 text-blue-800' : 'bg-gray-200 text-gray-800';
                            html += 
                                '<div class="flex ' + messageClass + ' mb-3">' +
                                '    <div class="max-w-xs md:max-w-md lg:max-w-lg ' + bubbleClass + ' rounded-lg p-3">' +
                                '        <div class="message-content">' + msg.content + '</div>' +
                                '        <div class="text-xs opacity-70 mt-1 text-right">' + time + '</div>' +
                                '</div>' +
                                '</div>';
                        });
                    }
                    messagesContainer.innerHTML = html;
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    // Устанавливаем возможность редактировать последнее сообщение
                    if (messages.length > 0 && (messages[messages.length - 1].is_owner || messages[messages.length - 1].sender_id === 0)) {
                        const editBtn = document.querySelector('button[onclick="editLastMessage()"]');
                        if (editBtn) editBtn.style.display = 'block';
                        window.lastMessageId = messages[messages.length - 1].id;
                    } else {
                        const editBtn = document.querySelector('button[onclick="editLastMessage()"]');
                        if (editBtn) editBtn.style.display = 'none';
                        window.lastMessageId = null;
                    }
                })
                .catch(error => {
                    console.error('Ошибка загрузки истории:', error);
                    messagesContainer.innerHTML = 
                        '<div class="bg-red-50 border border-red-200 rounded-lg p-4">' +
                        '    <p class="text-red-600">Ошибка загрузки истории сообщений</p>' +
                        '    <p class="text-red-500 text-sm">' + error.message + '</p>' +
                        '</div>';
                });
        }
        
        function sendAdminMessage() {
            if (!window.activeChatUser) {
                alert('Выберите пользователя для отправки сообщения');
                return;
            }
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;
            // Отправляем через WebSocket
            if (window.adminWebSocket && window.adminWebSocket.readyState === WebSocket.OPEN) {
                const messageData = {
                    type: 'admin_message',
                    user_id: window.activeChatUser.id,
                    content: message,
                    timestamp: new Date().toISOString()
                };
                window.adminWebSocket.send(JSON.stringify(messageData));
                // Добавляем сообщение в чат сразу
                const messagesContainer = document.getElementById('chat-messages-container');
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const newMessage = 
                    '<div class="flex justify-end mb-3">' +
                    '    <div class="max-w-xs md:max-w-md lg:max-w-lg bg-blue-100 text-blue-800 rounded-lg p-3">' +
                    '        <div class="message-content">' + message + '</div>' +
                    '        <div class="text-xs opacity-70 mt-1 text-right">' + time + ' (отправляется...)</div>' +
                    '    </div>' +
                    '</div>';
                messagesContainer.innerHTML += newMessage;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                input.value = '';
                // Сохраняем ID последнего сообщения для редактирования
                window.lastMessageId = 'pending_' + Date.now();
                const editBtn = document.querySelector('button[onclick="editLastMessage()"]');
                if (editBtn) editBtn.style.display = 'block';
                logToConsole('Отправлено сообщение пользователю ' + window.activeChatUser.name);
            } else {
                alert('WebSocket не подключен. Перезагрузите страницу.');
            }
        }
        
        function editLastMessage() {
            if (!window.lastMessageId || !window.activeChatUser) {
                alert('Нет сообщений для редактирования');
                return;
            }
            const messages = document.querySelectorAll('#chat-messages-container .flex.justify-end');
            if (messages.length === 0) return;
            const lastMessage = messages[messages.length - 1];
            const contentDiv = lastMessage.querySelector('.message-content');
            const currentText = contentDiv.textContent;
            const newText = prompt('Исправьте сообщение:', currentText);
            if (newText !== null && newText.trim() !== '' && newText !== currentText) {
                contentDiv.textContent = newText.trim();
                // Обновляем в базе данных (если сообщение уже сохранено)
                if (!window.lastMessageId.startsWith('pending_')) {
                    // Отправляем запрос на обновление сообщения
                    fetch('/api/chat/message/' + window.lastMessageId, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: newText.trim() })
                    })
                    .then(response => {
                        if (response.ok) {
                            logToConsole('Сообщение исправлено в базе данных');
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка обновления сообщения:', error);
                    });
                }
                logToConsole('Сообщение исправлено локально');
            }
        }
        
        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendAdminMessage();
            }
        }
        
        function refreshChatList() {
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown && !dropdown.classList.contains('hidden')) {
                loadUserDropdown();
            }
            logToConsole('Список пользователей обновлен');
        }
        
        // ========== WEB SOCKET ДЛЯ АДМИНА ==========
        function connectAdminWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = wsProtocol + '//' + window.location.host + '/api/chat/admin';
            window.adminWebSocket = new WebSocket(wsUrl);
            window.adminWebSocket.onopen = function() {
                logToConsole('WebSocket подключен (админ)');
                document.getElementById('ws-status').textContent = '🟢 Подключен';
                document.getElementById('ws-status').className = 'text-green-400';
            };
            window.adminWebSocket.onclose = function() {
                logToConsole('WebSocket отключен');
                document.getElementById('ws-status').textContent = '🔴 Отключен';
                document.getElementById('ws-status').className = 'text-red-400';
                // Переподключение через 5 секунд
                setTimeout(connectAdminWebSocket, 5000);
            };
            window.adminWebSocket.onerror = function(error) {
                logToConsole('Ошибка WebSocket');
                console.error('WebSocket error:', error);
            };
            window.adminWebSocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'new_message') {
                        // Новое сообщение от пользователя
                        if (window.activeChatUser && window.activeChatUser.id === data.user_id) {
                            // Показываем сообщение в активном чате
                            const messagesContainer = document.getElementById('chat-messages-container');
                            const time = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            messagesContainer.innerHTML += 
                                '<div class="flex justify-start mb-3">' +
                                '    <div class="max-w-xs md:max-w-md lg:max-w-lg bg-gray-200 text-gray-800 rounded-lg p-3">' +
                                '        <div class="message-content">' + data.content + '</div>' +
                                '        <div class="text-xs opacity-70 mt-1 text-right">' + time + '</div>' +
                                '</div>';
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            logToConsole('Новое сообщение от ' + window.activeChatUser.name);
                        }
                        // Показываем уведомление
                        if (!document.hasFocus() || !(window.activeChatUser && window.activeChatUser.id === data.user_id)) {
                            showNotification('Новое сообщение от пользователя #' + data.user_id, 'info');
                        }
                    }
                    else if (data.type === 'message_delivered') {
                        logToConsole('Сообщение доставлено: ' + data.message_id);
                    }
                    else if (data.type === 'error') {
                        logToConsole('Ошибка: ' + data.message);
                        showNotification(data.message, 'error');
                    }
                    else {
                        logToConsole('Получено: ' + event.data);
                    }
                } catch (error) {
                    console.error('Ошибка обработки сообщения:', error);
                    logToConsole('Ошибка обработки сообщения');
                }
            };
        }
        
        // Функция для загрузки быстрой статистики
        async function loadQuickStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                // Обновляем статистику в интерфейсе
                document.getElementById('stats-users').textContent = data.total_users;
                document.getElementById('stats-projects').textContent = data.total_projects;
                document.getElementById('stats-messages').textContent = data.total_messages;
                document.getElementById('stats-services').textContent = data.total_services;
                document.getElementById('stats-transactions').textContent = data.total_transactions;
                console.log('Статистика обновлена:', data);
            } catch (error) {
                console.error('Ошибка загрузки статистики:', error);
            }
        }
    </script>
</body>
</html>


