<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель администратора - AI Developer Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/chat-fix.css">
    <style>
        .sidebar { transition: all 0.3s; }
        .chat-panel { transition: all 0.3s; }
        .active-tab { background-color: #3b82f6; color: white; }
        .message-admin { background-color: #3b82f6; color: white; margin-left: auto; }
        .message-user { background-color: #e5e7eb; color: #1f2937; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); }
        
        #chat-input {
            color: #000000 !important;
            -webkit-text-fill-color: #000000 !important;
            opacity: 1 !important;
            font-weight: 400 !important;
            background-color: #ffffff !important;
        }
        
        #chat-input::placeholder {
            color: #666666 !important;
            opacity: 1 !important;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th {
            background-color: #f3f4f6;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        .data-table tr:hover {
            background-color: #f9fafb;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Верхняя панель -->
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold">AI Developer Portal - Админ-панель</h1>
                <span class="bg-blue-800 px-3 py-1 rounded-full text-sm">Администратор</span>
            </div>
            <div class="flex items-center space-x-4">
                <span id="admin-email">t72trak@gmail.com</span>
                <a href="/dashboard" class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded transition">В личный кабинет</a>
                <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded transition">Выход</button>
            </div>
        </div>
    </nav>
    
    <!-- Основной контейнер с тремя колонками -->
    <div class="container mx-auto flex mt-4 gap-4" style="min-height: calc(100vh - 140px);">
        <!-- ЛЕВАЯ КОЛОНКА: Навигация -->
        <div class="sidebar w-64 bg-white rounded-lg shadow-lg p-4 overflow-y-auto">
            <h2 class="text-lg font-bold mb-4 text-gray-700 border-b pb-2">📊 Навигация</h2>
            <div class="space-y-1">
                <button onclick="loadTab('users')" class="tab-btn w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center" id="tab-users">
                    <span class="mr-2">👤</span> Пользователи
                </button>
                <button onclick="loadTab('projects')" class="tab-btn w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center" id="tab-projects">
                    <span class="mr-2">📁</span> Проекты
                </button>
                <button onclick="loadTab('services')" class="tab-btn w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center" id="tab-services">
                    <span class="mr-2">🔧</span> Услуги
                </button>
                <button onclick="loadTab('transactions')" class="tab-btn w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center" id="tab-transactions">
                    <span class="mr-2">💰</span> Платежи
                </button>
                <button onclick="loadTab('statistics')" class="tab-btn w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center" id="tab-statistics">
                    <span class="mr-2">📈</span> Статистика
                </button>
                <button onclick="loadTab('settings')" class="tab-btn w-full text-left p-3 rounded hover:bg-blue-50 transition flex items-center" id="tab-settings">
                    <span class="mr-2">⚙️</span> Настройки
                </button>
            </div>
            
            <!-- Быстрая статистика -->
            <div class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-100">
                <h3 class="font-bold mb-3 text-gray-700 flex items-center">
                    <span class="mr-2">🚀</span> Быстрая статистика
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">👤 Пользователи:</span>
                        <span id="stats-users" class="font-bold text-blue-600 text-lg">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">📁 Проекты:</span>
                        <span id="stats-projects" class="font-bold text-green-600 text-lg">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">🛠️ Услуги:</span>
                        <span id="stats-services" class="font-bold text-yellow-600 text-lg">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">💬 Сообщения:</span>
                        <span id="stats-messages" class="font-bold text-purple-600 text-lg">0</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">💰 Транзакции:</span>
                        <span id="stats-transactions" class="font-bold text-red-600 text-lg">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ЦЕНТРАЛЬНАЯ КОЛОНКА: Контент -->
        <div class="flex-1 bg-white rounded-lg shadow-lg p-6 overflow-y-auto">
            <!-- Панель разработчика -->
            <div class="p-5 bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl border border-blue-200 shadow-sm mb-6">
                <h3 class="text-lg font-bold text-blue-800 mb-3 flex items-center">
                    <span class="mr-2">👨‍💻</span> Панель разработчика
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
                    <button onclick="testWebSocket()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center">
                        <span class="mr-2">🔌</span> Тест WebSocket
                    </button>
                    <button onclick="clearCache()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center">
                        <span class="mr-2">🧹</span> Очистить кэш
                    </button>
                    <button onclick="reloadData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center">
                        <span class="mr-2">🔄</span> Обновить данные
                    </button>
                </div>
                <div class="bg-gray-900 text-green-400 rounded-lg p-3 font-mono text-sm h-40 overflow-y-auto mb-6" id="dev-console">
                    <div class="text-gray-400">// Консоль разработчика</div>
                    <div>> Система инициализирована</div>
                    <div>> Ожидание команд...</div>
                </div>
            </div>

            <!-- Контейнер для контента вкладок -->
            <div id="content-area" class="mt-6">
                <div class="text-center py-10 text-gray-500">
                    <div class="text-4xl mb-4">👈</div>
                    <p class="text-xl">Выберите раздел в левом меню</p>
                    <p class="text-sm mt-2">Здесь будет отображаться содержимое выбранной вкладки</p>
                </div>
            </div>
        </div>
        
        <!-- ПРАВАЯ КОЛОНКА: Чат -->
        <div class="chat-panel w-80 bg-white rounded-lg shadow-lg flex flex-col">
            <!-- Заголовок чата -->
            <div class="p-4 border-b bg-gradient-to-r from-blue-50 to-indigo-50">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-lg font-bold text-gray-700 flex items-center">
                        <span class="mr-2">💬</span> Чат поддержки
                    </h2>
                    <span id="chat-status" class="px-3 py-1 bg-green-100 text-green-800 text-sm rounded-full flex items-center">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                        Онлайн
                    </span>
                </div>
                <div class="flex space-x-2 mb-3">
                    <div class="relative flex-1">
                        <input type="text" id="chat-search" placeholder="Поиск пользователя..."
                               class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                               onfocus="loadUserDropdown()" oninput="filterUsers()">
                        <div id="user-dropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden">
                            <div class="p-2 text-gray-500 text-center">Загрузка пользователей...</div>
                        </div>
                    </div>
                    <button onclick="refreshChatList()" class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition">
                        🔄
                    </button>
                </div>
            </div>
            
            <!-- Окно чата -->
            <div class="flex-1 flex flex-col p-3" id="chat-window">
                <div class="flex-1 overflow-y-auto mb-3 p-3 bg-gray-50 rounded-lg" id="chat-messages-container">
                    <div class="text-center py-8 text-gray-400">
                        <div class="text-3xl mb-2">💬</div>
                        <p>Выберите пользователя для начала общения</p>
                    </div>
                </div>
                <div class="border-t pt-3">
                    <div class="flex space-x-2 mb-2 items-stretch">
                        <textarea id="chat-input" placeholder="Введите сообщение..." 
                                  class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 resize-none" 
                                  rows="2" onkeydown="handleChatKeydown(event)"></textarea>
                        <button onclick="sendAdminMessage()" 
                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg transition flex items-center justify-center whitespace-nowrap font-medium h-auto">
                            Отправить
                        </button>
                    </div>
                    <div class="flex justify-between items-center">
                        <button onclick="editLastMessage()" class="text-sm text-gray-500 hover:text-gray-700">
                            ✏️ Исправить последнее
                        </button>
                        <div class="text-xs text-gray-400">
                            Enter - отправить, Shift+Enter - новая строка
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Подвал -->
    <footer class="bg-gray-800 text-white p-4 mt-4">
        <div class="container mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <p>© 2024 Front end & Back end. Все права защищены.</p>
                <div class="mt-2 md:mt-0 text-sm text-gray-400">
                    <span>Версия: 2.0.0 | </span>
                    <span>Сервер: <span id="server-status" class="text-green-400">🟢 Работает</span> | </span>
                    <span>WebSocket: <span id="ws-status" class="text-green-400">🟢 Подключен</span></span>
                </div>
            </div>
        </div>
    </footer>
    
    <script src="/static/js/admin.js"></script>
    <script>
        // ========== ИНИЦИАЛИЗАЦИЯ ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Админ-панель инициализируется...');
            
            // Проверяем авторизацию
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
                return;
            }
            
            // Устанавливаем активную вкладку
            document.getElementById('tab-users').classList.add('active-tab');
            
            // Загружаем статистику
            loadQuickStats();
            
            // Подключаемся к WebSocket как админ
            setTimeout(connectAdminWebSocket, 1000);
            
            // Обновляем email админа
            updateAdminEmail();
            
            // Принудительно применяем стили для поля ввода чата
            setTimeout(function() {
                const chatInput = document.getElementById('chat-input');
                if (chatInput) {
                    chatInput.style.color = '#000000';
                    chatInput.style.backgroundColor = '#ffffff';
                    chatInput.style.opacity = '1';
                }
            }, 500);
        });

        // ========== АВТОРИЗАЦИЯ ==========
        function updateAdminEmail() {
            const adminEmail = localStorage.getItem('user_email') || 't72trak@gmail.com';
            document.getElementById('admin-email').textContent = adminEmail;
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_id');
            localStorage.removeItem('user_email');
            localStorage.removeItem('user_name');
            window.location.href = '/login';
        }

        // ========== ЗАГРУЗКА ВКЛАДОК (ПОЛНОСТЬЮ ПЕРЕРАБОТАНО) ==========
        async function loadTab(tabName) {
            console.log('Загрузка вкладки:', tabName);
            
            // Удаляем активный класс у всех кнопок
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active-tab');
            });
            
            // Добавляем активный класс текущей кнопке
            const currentTab = document.getElementById('tab-' + tabName);
            if (currentTab) {
                currentTab.classList.add('active-tab');
            }
            
            // Показываем загрузку
            document.getElementById('content-area').innerHTML = `
                <div class="flex flex-col items-center justify-center py-20">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                    <p class="text-gray-600">Загрузка раздела "${tabName}"...</p>
                </div>
            `;
            
            try {
                // Получаем токен из localStorage
                const token = localStorage.getItem('access_token');
                
                // Загружаем данные в зависимости от вкладки
                switch(tabName) {
                    case 'users':
                        await loadUsersTab(token);
                        break;
                    case 'projects':
                        await loadProjectsTab(token);
                        break;
                    case 'services':
                        await loadServicesTab(token);
                        break;
                    case 'transactions':
                        await loadTransactionsTab(token);
                        break;
                    case 'statistics':
                        await loadStatisticsTab(token);
                        break;
                    case 'settings':
                        await loadSettingsTab(token);
                        break;
                    default:
                        document.getElementById('content-area').innerHTML = '<p class="text-red-500">Неизвестная вкладка</p>';
                }
                
                logToConsole(`Вкладка "${tabName}" загружена`);
                
            } catch (error) {
                console.error('Ошибка загрузки вкладки:', error);
                document.getElementById('content-area').innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                        <h3 class="text-red-800 font-bold text-lg mb-2 flex items-center">
                            <span class="mr-2">⚠️</span> Ошибка загрузки
                        </h3>
                        <p class="text-red-600 mb-4">Не удалось загрузить раздел "${tabName}"</p>
                        <div class="bg-red-100 p-3 rounded text-sm text-red-800 mb-4">
                            <strong>Детали:</strong> ${error.message}
                        </div>
                        <button onclick="loadTab('${tabName}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition">
                            Попробовать снова
                        </button>
                    </div>
                `;
            }
        }

        // ========== ВКЛАДКА: ПОЛЬЗОВАТЕЛИ ==========
        async function loadUsersTab(token) {
            const response = await fetch('/api/admin/users', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            
            let html = `
                <div class="bg-white rounded-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">👥 Управление пользователями</h2>
                        <button onclick="showAddUserForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                            <span class="mr-2">➕</span> Добавить пользователя
                        </button>
                    </div>
                    
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <span class="text-blue-600 text-xl">📊</span>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-blue-800">
                                    Всего пользователей: <span class="font-bold">${data.count || 0}</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Имя</th>
                                    <th>Email</th>
                                    <th>Роль</th>
                                    <th>Дата регистрации</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            if (data.users && data.users.length > 0) {
                data.users.forEach(user => {
                    const isAdmin = user.is_admin ? 'Администратор' : 'Пользователь';
                    const adminClass = user.is_admin ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800';
                    const createdDate = user.created_at ? new Date(user.created_at).toLocaleDateString() : 'Н/Д';
                    
                    html += `
                        <tr>
                            <td class="font-mono">${user.id}</td>
                            <td class="font-medium">${user.name || '—'}</td>
                            <td>${user.email}</td>
                            <td>
                                <span class="px-2 py-1 text-xs rounded-full ${adminClass}">
                                    ${isAdmin}
                                </span>
                            </td>
                            <td>${createdDate}</td>
                            <td>
                                <button onclick="editUser(${user.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Редактировать">
                                    ✏️
                                </button>
                                <button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-800" title="Удалить">
                                    🗑️
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                html += `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            Пользователи не найдены
                        </td>
                    </tr>
                `;
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('content-area').innerHTML = html;
        }

        // ========== ВКЛАДКА: ПРОЕКТЫ ==========
        async function loadProjectsTab(token) {
            const response = await fetch('/api/admin/projects', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            
            let html = `
                <div class="bg-white rounded-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">📁 Управление проектами</h2>
                        <button onclick="showAddProjectForm()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                            <span class="mr-2">➕</span> Создать проект
                        </button>
                    </div>
                    
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <span class="text-green-600 text-xl">📊</span>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-green-800">
                                    Всего проектов: <span class="font-bold">${data.count || 0}</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Название</th>
                                    <th>Владелец</th>
                                    <th>Статус</th>
                                    <th>Дата создания</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            if (data.projects && data.projects.length > 0) {
                data.projects.forEach(project => {
                    const statusClass = {
                        'active': 'bg-green-100 text-green-800',
                        'completed': 'bg-blue-100 text-blue-800',
                        'pending': 'bg-yellow-100 text-yellow-800'
                    }[project.status] || 'bg-gray-100 text-gray-800';
                    
                    const statusText = {
                        'active': 'Активен',
                        'completed': 'Завершен',
                        'pending': 'В ожидании'
                    }[project.status] || project.status || 'Неизвестно';
                    
                    html += `
                        <tr>
                            <td class="font-mono">${project.id}</td>
                            <td class="font-medium">${project.name}</td>
                            <td>${project.user_id || '—'}</td>
                            <td>
                                <span class="px-2 py-1 text-xs rounded-full ${statusClass}">
                                    ${statusText}
                                </span>
                            </td>
                            <td>${project.created_at ? new Date(project.created_at).toLocaleDateString() : 'Н/Д'}</td>
                            <td>
                                <button onclick="editProject(${project.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Редактировать">
                                    ✏️
                                </button>
                                <button onclick="deleteProject(${project.id})" class="text-red-600 hover:text-red-800" title="Удалить">
                                    🗑️
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                html += `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            Проекты не найдены
                        </td>
                    </tr>
                `;
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('content-area').innerHTML = html;
        }

        // ========== ВКЛАДКА: УСЛУГИ ==========
        async function loadServicesTab(token) {
            const response = await fetch('/api/admin/services', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            
            let html = `
                <div class="bg-white rounded-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">🔧 Управление услугами</h2>
                        <button onclick="showAddServiceForm()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                            <span class="mr-2">➕</span> Добавить услугу
                        </button>
                    </div>
                    
                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <span class="text-yellow-600 text-xl">📊</span>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-yellow-800">
                                    Всего услуг: <span class="font-bold">${data.count || 0}</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Название</th>
                                    <th>Описание</th>
                                    <th>Цена</th>
                                    <th>Категория</th>
                                    <th>Статус</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            if (data.services && data.services.length > 0) {
                data.services.forEach(service => {
                    const activeClass = service.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const activeText = service.is_active ? 'Активна' : 'Неактивна';
                    
                    html += `
                        <tr>
                            <td class="font-mono">${service.id}</td>
                            <td class="font-medium">${service.name}</td>
                            <td>${service.description || '—'}</td>
                            <td class="font-bold">${service.price || 0} ₽</td>
                            <td>${service.category || 'Общее'}</td>
                            <td>
                                <span class="px-2 py-1 text-xs rounded-full ${activeClass}">
                                    ${activeText}
                                </span>
                            </td>
                            <td>
                                <button onclick="editService(${service.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Редактировать">
                                    ✏️
                                </button>
                                <button onclick="deleteService(${service.id})" class="text-red-600 hover:text-red-800" title="Удалить">
                                    🗑️
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                html += `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-gray-500">
                            Услуги не найдены
                        </td>
                    </tr>
                `;
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('content-area').innerHTML = html;
        }

        // ========== ВКЛАДКА: ТРАНЗАКЦИИ ==========
        async function loadTransactionsTab(token) {
            const response = await fetch('/api/admin/transactions', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            
            let html = `
                <div class="bg-white rounded-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">💰 Управление платежами</h2>
                        <div class="flex space-x-2">
                            <button onclick="loadTransactionsStats()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                                <span class="mr-2">📊</span> Статистика
                            </button>
                            <button onclick="exportTransactions()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                                <span class="mr-2">📥</span> Экспорт
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <span class="text-red-600 text-xl">📊</span>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-red-800">
                                    Всего транзакций: <span class="font-bold">${data.total || data.count || 0}</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Пользователь</th>
                                    <th>Сумма</th>
                                    <th>Тип</th>
                                    <th>Статус</th>
                                    <th>Дата</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            if (data.transactions && data.transactions.length > 0) {
                data.transactions.forEach(transaction => {
                    const statusClass = {
                        'completed': 'bg-green-100 text-green-800',
                        'pending': 'bg-yellow-100 text-yellow-800',
                        'failed': 'bg-red-100 text-red-800'
                    }[transaction.status] || 'bg-gray-100 text-gray-800';
                    
                    html += `
                        <tr>
                            <td class="font-mono">${transaction.id}</td>
                            <td>${transaction.user_id || '—'}</td>
                            <td class="font-bold">${transaction.amount || 0} ₽</td>
                            <td>${transaction.type || 'Платеж'}</td>
                            <td>
                                <span class="px-2 py-1 text-xs rounded-full ${statusClass}">
                                    ${transaction.status || 'Неизвестно'}
                                </span>
                            </td>
                            <td>${transaction.created_at ? new Date(transaction.created_at).toLocaleDateString() : 'Н/Д'}</td>
                            <td>
                                <button onclick="viewTransaction(${transaction.id})" class="text-blue-600 hover:text-blue-800" title="Просмотр">
                                    🔍
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                html += `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-gray-500">
                            Транзакции не найдены
                        </td>
                    </tr>
                `;
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('content-area').innerHTML = html;
        }

        // ========== ВКЛАДКА: СТАТИСТИКА ==========
        async function loadStatisticsTab(token) {
            const response = await fetch('/api/admin/statistics', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const data = await response.json();
            const stats = data.statistics || {};
            const overview = stats.overview || {};
            const today = stats.today || {};
            const messages = stats.messages || {};
            const users = stats.users || {};
            
            let html = `
                <div class="bg-white rounded-lg">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">📈 Детальная статистика</h2>
                    
                    <!-- Основные метрики -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg p-6 shadow-lg">
                            <div class="text-3xl mb-2">👥</div>
                            <div class="text-sm opacity-90">Пользователи</div>
                            <div class="text-3xl font-bold mt-1">${overview.total_users || 0