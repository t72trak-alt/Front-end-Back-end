from fastapi import APIRouter, Depends, HTTPException, status
from sqlalchemy.orm import Session
from datetime import datetime, timedelta
from typing import List, Optional
import app.database as database
import app.models as models
import app.schemas as schemas
from app.dependencies import get_current_user

router = APIRouter(
    prefix="/api/admin",
    tags=["admin"]
)

def get_db():
    db = database.SessionLocal()
    try:
        yield db
    finally:
        db.close()

def check_admin(user: models.User):
    if not user.is_admin:
        raise HTTPException(status_code=403, detail="Требуются права администратора")
    return user

# ================ ПОЛЬЗОВАТЕЛИ ================
@router.get("/users")
async def get_all_users(
    current_user: models.User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Получить всех пользователей"""
    check_admin(current_user)
    users = db.query(models.User).all()
    return {
        "status": "success",
        "count": len(users),
        "users": users
    }

# ================ ПРОЕКТЫ ================
@router.get("/projects")
async def get_all_projects(
    current_user: models.User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Получить все проекты"""
    check_admin(current_user)
    projects = db.query(models.Project).all()
    return {
        "status": "success",
        "count": len(projects),
        "projects": projects
    }

# ================ УСЛУГИ (SERVICES) ================
@router.get("/services")
async def get_all_services(
    current_user: models.User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Получить все услуги"""
    check_admin(current_user)
    services = db.query(models.Service).all()
    return {
        "status": "success",
        "count": len(services),
        "services": services
    }

@router.post("/services")
async def create_service(
    service_data: dict,
    current_user: models.User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Создать новую услугу"""
    check_admin(current_user)
    
    new_service = models.Service(
        name=service_data.get("name"),
        description=service_data.get("description", ""),
        price=service_data.get("price", 0),
        category=service_data.get("category", "general"),
        is_active=service_data.get("is_active", True),
        created_at=datetime.utcnow()
    )
    
    db.add(new_service)
    db.commit()
    db.refresh(new_service)
    
    return {
        "status": "success",
        "message": "Услуга создана",
        "service": new_service
    }

@router.put("/services/{service_id}")
async def update_service(
    service_id: int,
    service_data: dict,
    current_user: models.User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Обновить услугу"""
    check_admin(current_user)
    
    service = db.query(models.Service).filter(models.Service.id == service_id).first()
    if not service:
        raise HTTPException(status_code=404, detail="Услуга не найдена")
    
    # Обновляем только переданные поля
    if "name" in service_data:
        service.name = service_data["name"]
    if "description" in service_data:
        service.description = service_data["description"]
    if "price" in service_data:
        service.price = service_data["price"]
    if "category" in service_data:
        service.category = service_data["category"]
    if "is_active" in service_data:
        service.is_active = service_data["is_active"]
    
    db.commit()
    db.refresh(service)
    
    return {
        "status": "success",
        "message": "Услуга обновлена",
        "service": service
    }

@router.delete("/services/{service_id}")
async def delete_service(
    service_id: int,
    current_user: models.User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Удалить услугу"""
    check_admin(current_user)
    
    service = db.query(models.Service).filter(models.Service.id == service_id).first()
    if not service:
        raise HTTPException(status_code=404, detail="Услуга не найдена")
    
    db.delete(service)
    db.commit()
    
    return {
        "status": "success",
        "message": "Услуга удалена"
    }

# ================ ТРАНЗАКЦИИ ================
@router.get("/transactions")
async def get_all_transactions(
    current_user: models.User = Depends(get_current_user),
    db: Session = Depends(get_db),
    limit: int = 100,
    offset: int = 0
):
    """Получить все транзакции"""
    check_admin(current_user)
    
    # Проверяем существует ли таблица transactions
    from sqlalchemy import inspect
    inspector = inspect(db.bind)
    if 'transactions' not in inspector.get_table_names():
        return {
            "status": "success",
            "count": 0,
            "transactions": [],
            "message": "Таблица транзакций не создана"
        }
    
    transactions = db.query(models.Transaction).order_by(
        models.Transaction.created_at.desc()
    ).offset(offset).limit(limit).all()
    
    total = db.query(models.Transaction).count()
    
    return {
        "status": "success",
        "count": len(transactions),
        "total": total,
        "transactions": transactions
    }

@router.get("/transactions/stats")
async def get_transactions_stats(
    current_user: models.User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Статистика по транзакциям"""
    check_admin(current_user)
    
    # Проверяем существует ли таблица
    from sqlalchemy import inspect, func
    inspector = inspect(db.bind)
    if 'transactions' not in inspector.get_table_names():
        return {
            "status": "success",
            "stats": {
                "total_transactions": 0,
                "total_revenue": 0,
                "average_amount": 0,
                "last_month_revenue": 0
            }
        }
    
    total_transactions = db.query(models.Transaction).count()
    
    # Общая сумма
    total_revenue = db.query(func.sum(models.Transaction.amount)).scalar() or 0
    
    # Средний чек
    average_amount = total_revenue / total_transactions if total_transactions > 0 else 0
    
    # За последние 30 дней
    thirty_days_ago = datetime.utcnow() - timedelta(days=30)
    last_month_revenue = db.query(func.sum(models.Transaction.amount)).filter(
        models.Transaction.created_at >= thirty_days_ago
    ).scalar() or 0
    
    return {
        "status": "success",
        "stats": {
            "total_transactions": total_transactions,
            "total_revenue": float(total_revenue),
            "average_amount": float(average_amount),
            "last_month_revenue": float(last_month_revenue)
        }
    }

# ================ НАСТРОЙКИ (SETTINGS) ================
@router.get("/settings")
async def get_settings(
    current_user: models.User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Получить настройки системы"""
    check_admin(current_user)
    
    # Проверяем существует ли таблица settings
    from sqlalchemy import inspect
    inspector = inspect(db.bind)
    if 'settings' not in inspector.get_table_names():
        # Возвращаем настройки по умолчанию
        return {
            "status": "success",
            "settings": {
                "site_name": "Front end & Back end 3",
                "site_description": "Платформа для управления проектами",
                "admin_email": "admin@example.com",
                "maintenance_mode": False,
                "registration_enabled": True,
                "default_user_role": "user",
                "chat_enabled": True,
                "max_file_size": 10485760,  # 10 MB
                "allowed_file_types": [".jpg", ".png", ".pdf", ".docx"],
                "timezone": "UTC",
                "language": "ru"
            }
        }
    
    settings = db.query(models.Setting).all()
    settings_dict = {s.key: s.value for s in settings}
    
    return {
        "status": "success",
        "settings": settings_dict
    }

@router.put("/settings")
async def update_settings(
    settings_data: dict,
    current_user: models.User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Обновить настройки системы"""
    check_admin(current_user)
    
    # Проверяем существует ли таблица settings
    from sqlalchemy import inspect
    inspector = inspect(db.bind)
    if 'settings' not in inspector.get_table_names():
        # Создаём таблицу settings
        from app.database import Base
        Base.metadata.create_all(bind=db.bind, tables=[models.Setting.__table__])
    
    updated_settings = []
    for key, value in settings_data.items():
        setting = db.query(models.Setting).filter(models.Setting.key == key).first()
        if setting:
            setting.value = str(value)
            setting.updated_at = datetime.utcnow()
        else:
            setting = models.Setting(
                key=key,
                value=str(value),
                created_at=datetime.utcnow()
            )
            db.add(setting)
        updated_settings.append({key: value})
    
    db.commit()
    
    return {
        "status": "success",
        "message": "Настройки обновлены",
        "settings": settings_data
    }

# ================ РАСШИРЕННАЯ СТАТИСТИКА ================
@router.get("/statistics")
async def get_detailed_statistics(
    current_user: models.User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Детальная статистика для админ-панели"""
    check_admin(current_user)
    
    # Основные счетчики
    total_users = db.query(models.User).count()
    total_projects = db.query(models.Project).count()
    total_services = db.query(models.Service).count()
    total_messages = db.query(models.Message).count()
    
    # Новые пользователи за сегодня
    today_start = datetime.utcnow().replace(hour=0, minute=0, second=0, microsecond=0)
    new_users_today = db.query(models.User).filter(
        models.User.created_at >= today_start
    ).count()
    
    # Новые проекты за сегодня
    new_projects_today = db.query(models.Project).filter(
        models.Project.created_at >= today_start
    ).count()
    
    # Статистика по сообщениям
    from sqlalchemy import func
    messages_stats = db.query(
        func.count(models.Message.id).label('total'),
        func.sum(models.Message.is_owner.cast(models.Integer)).label('user_messages')
    ).first()
    
    user_messages = messages_stats.user_messages or 0
    admin_messages = (messages_stats.total or 0) - user_messages
    
    # Статистика по ролям
    admins_count = db.query(models.User).filter(models.User.is_admin == True).count()
    regular_users = total_users - admins_count
    
    return {
        "status": "success",
        "statistics": {
            "overview": {
                "total_users": total_users,
                "total_projects": total_projects,
                "total_services": total_services,
                "total_messages": total_messages
            },
            "today": {
                "new_users": new_users_today,
                "new_projects": new_projects_today
            },
            "messages": {
                "total": messages_stats.total or 0,
                "from_users": user_messages,
                "from_admin": admin_messages,
                "user_percentage": round((user_messages / messages_stats.total * 100), 2) if messages_stats.total else 0
            },
            "users": {
                "total": total_users,
                "admins": admins_count,
                "regular": regular_users,
                "admin_percentage": round((admins_count / total_users * 100), 2) if total_users else 0
            }
        }
    }

# ================ СТАТИСТИКА ПО ЧАТУ (ДОПОЛНИТЕЛЬНО) ================
@router.get("/stats/chat")
async def get_chat_statistics(
    current_user: models.User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Статистика по чату для админ-панели"""
    check_admin(current_user)
    
    from sqlalchemy import func
    
    # Общее количество сообщений
    total_messages = db.query(models.Message).count()
    
    # Сообщения по дням за последние 7 дней
    seven_days_ago = datetime.utcnow() - timedelta(days=7)
    messages_by_day = db.query(
        func.date(models.Message.created_at).label('date'),
        func.count(models.Message.id).label('count')
    ).filter(
        models.Message.created_at >= seven_days_ago
    ).group_by(
        func.date(models.Message.created_at)
    ).all()
    
    # Активные пользователи (те, кто писал за последние 24 часа)
    day_ago = datetime.utcnow() - timedelta(days=1)
    active_users = db.query(models.Message.user_id).filter(
        models.Message.created_at >= day_ago
    ).distinct().count()
    
    return {
        "status": "success",
        "stats": {
            "total_messages": total_messages,
            "active_users_24h": active_users,
            "messages_last_7_days": [
                {"date": str(day.date), "count": day.count} 
                for day in messages_by_day
            ]
        }
    }